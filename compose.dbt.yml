# IMPORTANT: For testing dbt before moving to docker compose airflow with dbt
# Check the configuration path.

name: dbt-instance
x-common-config:
  &dbt-common-config
  build: 
    context: .
    dockerfile: Dockerfile
  volumes:
    - ${DBT_PROJECT_DIR:-.}/analyses:${DBT_CONT_DIR:-/app/dbt}/analyses
    - ${DBT_PROJECT_DIR:-.}/macros:${DBT_CONT_DIR:-/app/dbt}/macros
    - ${DBT_PROJECT_DIR:-.}/models:${DBT_CONT_DIR:-/app/dbt}/models
    - ${DBT_PROJECT_DIR:-.}/snapshots:${DBT_CONT_DIR:-/app/dbt}/snapshots
    - ${DBT_PROJECT_DIR:-.}/seeds:${DBT_CONT_DIR:-/app/dbt}/seeds
  env_file:
    - .env

services:
  ui:
    <<: *dbt-common-config
    tty: true
    entrypoint: /bin/sh
    command: -c "dbt deps && dbt docs generate && dbt docs serve --port 8080 --host 0.0.0.0"
    ports:
      - "${PORT_DBT_UI:-8888}:8080"
  
  debug:
    <<: *dbt-common-config
    tty: true
    entrypoint: /bin/sh
    command: -c "dbt deps && dbt debug"